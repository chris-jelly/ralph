## Codebase Patterns
- To unit test shell functions defined in a script without side effects, extract them using sed: `eval "$(sed -n '/^func() {/,/^}/p' script.sh)"`
- The ralph/AGENTS.md file is the instructions file given to each AI agent instance (copied to ralph/ directory during installation)

## 2026-01-31 - US-004
- Implemented robust path validation in `ralph/install.sh`.
- Added validation to ensure `TARGET_DIR` exists after expansion.
- Added validation to ensure `RALPH_DIR_NAME` parent directory exists (if outside the target directory).
- Created `tests/test_validation.sh` to verify error conditions.
- Files changed: `ralph/install.sh`, `tests/test_validation.sh`
- **Learnings for future iterations:**
  - When validating paths where `mkdir -p` will be used later, check if the path is a child of a known existing directory (like `TARGET_DIR`) to avoid false positives.
  - Bash string manipulation (prefix check) is sufficient for simple "is child of" checks if paths are canonicalized.
---
## 2026-01-31 - US-005
- Updated `ralph/install.sh` help message with path format examples.
- Updated root `README.md` with path format examples in the Installation section.
- Files changed: `ralph/install.sh`, `README.md`
- **Learnings for future iterations:**
  - The `ralph/README.md` file seems to be a template or unused doc, while the root `README.md` contains the actual installation instructions.
  - `ralph/install.sh` generates its own README for the installed instance, rather than copying `ralph/README.md`.
---
## 2026-01-31 - US-006
- Created `tests/test_install_paths.sh` to validate `expand_path` functionality.
- Used `sed` to extract the `expand_path` function from `ralph/install.sh` for isolated testing.
- Verified all path expansion scenarios: ~, $HOME, relative paths, absolute paths, mixed formats.
- Files changed: `tests/test_install_paths.sh`
- **Learnings for future iterations:**
  - Testing internal shell functions is possible by extracting them with `sed` and `eval`, allowing unit testing without running the full script side effects.
  - `os.path.abspath` in Python (used for expansion) strips trailing slashes, so expectations should match that behavior.
---
## 2025-02-01 - US-001
- Updated ralph/AGENTS.md to include specifications system awareness
- Added step 5 to check for specifications/AGENTS.md and read relevant specifications based on current story context
- Renumbered steps 5-10 to 6-11
- Added rule in Important section: "Do NOT edit anything in the specifications/ directory"
- Files changed: ralph/AGENTS.md
- **Learnings for future iterations:**
  - ralph/AGENTS.md is the main instruction file given to each AI agent instance
  - When updating numbered steps, always update all subsequent steps to maintain order
---
## 2026-02-01 - US-002
- Added specifications scaffolding to install.sh
- Created specifications/ directory in $TARGET_DIR during installation
- Wrote template specifications/AGENTS.md with routing rules format
- Template includes header explaining conventions and note that Ralph never edits specifications
- No example spec files in template (user adds their own)
- Files changed: ralph/install.sh
- **Learnings for future iterations:**
  - Use `cat << 'EOF'` (single quotes) to avoid variable expansion in heredocs when writing literal template content
---
## 2026-02-01 - US-003
- Added specifications check to ralph/doctor.sh
- Check always passes (informational only, does not affect FAILED status)
- Three informational states:
  - No specifications/ directory: "INFO: No specifications/ directory found (optional)"
  - specifications/ without AGENTS.md: "INFO: specifications/ exists but missing AGENTS.md index"
  - specifications/ with AGENTS.md: "PASS: Specifications configured"
- Check runs after all existing validation checks
- Files changed: ralph/doctor.sh, plans/prd.json
- **Learnings for future iterations:**
  - When adding informational checks to doctor.sh, do not set FAILED=1 or report_fail() - just use echo with INFO or PASS labels
  - The ralph/ directory is the source distribution; scripts/ralph/ is a local installation (may be out of sync)
  - Test all three conditional paths (true/false states) for new checks
---
## 2026-02-01 - US-004
- Added Specifications section to ralph/README.md
- Explained purpose: human-curated project docs for selective AI agent reading
- Documented specifications/AGENTS.md role as index/router
- Showed example structure with 3 hypothetical spec files (api-patterns.md, ui-components.md, database-schema.md)
- Noted that Ralph reads specs selectively and never modifies specification files
- Kept documentation concise (quick reference level)
- Files changed: ralph/README.md
- **Learnings for future iterations:**
  - When adding documentation to README.md, keep sections brief and focused
  - Markdown README files don't require typechecking or linting
  - Example structures help users understand how to organize specification files
---
## 2026-02-02 - US-002
- Added mode argument parsing to ralph.sh supporting three modes: build, plan, summary
- Build mode preserves all existing behavior and uses AGENTS.md as prompt
- Plan mode archives existing prd.json/progress.txt to plans/archive/ before starting, uses AGENTS_plan.md
- Summary mode runs as single iteration using AGENTS_summary.md, no archiving
- Updated --help to document all modes and CLI examples
- Build mode: default behavior, './ralph.sh [max_iterations]'
- Plan mode: './ralph.sh plan [max_iterations]', archives first
- Summary mode: './ralph.sh summary', single iteration no loop
- Syntax check: bash -n passes
- All existing tests pass (test_validation.sh, test_install_paths.sh, test_us003_integration.sh)
- Shellcheck not installed in environment (accepted, noted in acceptance criteria)
- Files changed: ralph/ralph.sh
- **Learnings for future iterations:**
  - Argument parsing for modes should be done early, before any path setup
  - When adding new modes, preserve all existing build-mode behavior (tool selection, COMPLETE detection, sleep, branch archival)
  - Summary mode requires special handling: single iteration, no loop, no archive, no branch tracking
  - Plan mode archiving resets progress.txt with fresh header to start new planning cycle
---
## 2026-02-02 - US-003
- Created ralph/AGENTS_plan.md with instructions for plan mode
- Prompts agent to read plans/implementation_plan.md and specs/AGENTS.md for routing
- Instructs agent to search codebase to determine what exists vs what is missing
- Instructs agent to generate prd.json with prioritized user stories
- Instructs agent to update implementation_plan.md with findings (what exists, missing, blockers)
- Explicitly forbids modifying source code files or specs/ directory
- Mentions parallel subagents can be used for codebase search
- Uses <promise>COMPLETE</promise> signal when plan is ready
- No model-specific references
- All existing tests pass (test_validation.sh, test_install_paths.sh, test_us003_integration.sh)
- Files changed: ralph/AGENTS_plan.md
- **Learnings for future iterations:**
  - AGENTS_plan.md follows same structure as AGENTS.md but is read-only (no code changes)
  - Plan mode outputs findings to implementation_plan.md instead of progress.txt
  - Subagents are mentioned as optional tool for parallel searches in prompt instructions
